
(require 'asdf)

(progn
  ;;; Code i've added to automatically find the package directories and add
  ;;; them to the central registry.
  ;;; This works with clisp, at least.
  (defun add-all-packages (base-dir)
    (dolist (asd-file (directory (merge-pathnames #P"*/*.asd" base-dir)))
      (pushnew (make-pathname :directory (pathname-directory asd-file))
               asdf:*central-registry*
               :test #'equal)))
  (add-all-packages (merge-pathnames #P"lisp/packages/" (user-homedir-pathname))))

#|
 | I used this function to put symlinks in ~/lisp/systems/, but that was more
 | trouble than it was worth.
 |
#-win32
(pushnew (merge-pathnames #P"lisp/systems/" (user-homedir-pathname))
         asdf:*central-registry* :test #'equal)
|#


;;; things to load to get slime working
#+win32
(require 'sb-introspect)

;;; for command-line scripts
(let ((script (and (second *posix-argv*)
                   (probe-file (second *posix-argv*)))))
  (when script
    ;; handle shebang-line
    (set-dispatch-macro-character #\# #\!
                                  (lambda (stream char arg)
                                    (declare (ignore char arg))
                                    (read-line stream)))
    ;; disable debugger
    (setf *invoke-debugger-hook*
          #'(lambda (condition hook)
              (declare (ignore condition hook))
              ;; uncomment to get backtraces on errors
              ;; (sb-debug:backtrace 20)
              (quit)))
    (load script)
    (quit)))

(defun asdf (lib)
  "Shortcut for ASDF."
  (asdf:oos 'asdf:load-op lib))

; vim: set filetype=lisp:
